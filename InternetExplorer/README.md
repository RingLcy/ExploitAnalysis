# 调试常用断点
1. bu vbscript!VbsIsEmpty ".printf \"VbsIsEmpty Output:\\n\"; .if(wo(poi(esp+c))== 8) {du poi((poi(esp+c)+8))} .else {dd poi(esp+c)}"
2. bu vbscript!CScriptRuntime::RunNoEH "!py C:\\tools\\kl_vbs_disasm_windbg.py"
3. bu jscript9!Js::Math::Atan ".printf \"DEBUG: %mu\\n\", poi(poi(esp+10)+c);g"
4. bu jscript9!Js::Math::Atan2 ".printf \"DEBUG: %mu\\n\", poi(poi(esp+14)+c);"
5. s -d 0 L?80000000 xxxx xxxx
6. Flash调试，js 帮助函数
```
<script>
        function debug_stop(text){
            Math.atan2(0xbadc0de, text);
        }
        
        function debug_continue(text){
            Math.atan(text);
        }
</script>

```


# JavascriptBasics
## DOM(IE10)
- https://www.jianshu.com/p/3d8a4ba86bbe
- https://www.jianshu.com/p/8cd37ffe9a98
- https://www.cnblogs.com/Ox9A82/p/5782425.html


```
<html>
  <body>
    <script>
        alert("111");
    </script>
  </body>
  
</html>
```

```
bu MSHTML!CMarkup::CMarkup "gu; .printf \"New CMarkup Object: %p\\n\",eax ;"
bu MSHTML!CMarkup::~CMarkup ".printf \"Release CMarkup Object: %p\\n\",ecx; gu;"
bu MSHTML!CreateElement+0x64 "ln eax; gu; .printf \"Element Address: %p\\n\",poi(ebp-4); "
```

可以看到Dom节点的建立过程，每个tag对应一个Element对象，而CMarkup相当于一个容器，管理着它负责的这个Dom流

```
0:018> g
New CMarkup Object: 0b4bccc0
eax=0b4bccc0 ebx=04acbe68 ecx=0b212fe8 edx=01e2f2ec esi=0b4bccc0 edi=070a0fc0
eip=6afe382b esp=04acbcc0 ebp=04acbe48 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
MSHTML!CDoc::CreateMarkupFromInfo+0x192:
6afe382b 8bd8            mov     ebx,eax
0:007> g
(6afe98ec)   MSHTML!CHtmlElement::CreateElement   |  (6afe99c0)   MSHTML!CHtmlElement::`vftable'
Exact matches:
    MSHTML!CHtmlElement::CreateElement = <no type information>
Element Address: 0bc1ffc8
eax=00000000 ebx=0bb33f00 ecx=0bb33f00 edx=04acc150 esi=0bb33f00 edi=0bd14cf8
eip=6b032b29 esp=04acc1a4 ebp=04acc1bc iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
MSHTML!CHtml5TreeConstructor::InsertAnHTMLElement+0x48:
6b032b29 8b75fc          mov     esi,dword ptr [ebp-4] ss:0023:04acc1b8=0bc1ffc8
0:007> g
(6b1b497b)   MSHTML!CHeadElement::CreateElement   |  (6b1b4a40)   MSHTML!CHeadElement::`vftable'
Exact matches:
    MSHTML!CHeadElement::CreateElement = <no type information>
Element Address: 0bd2bfc8
eax=00000000 ebx=0bd14d60 ecx=00000036 edx=6af96e25 esi=0bd14d60 edi=0bd14cf8
eip=6b032b29 esp=04acc0d8 ebp=04acc0f0 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
MSHTML!CHtml5TreeConstructor::InsertAnHTMLElement+0x48:
6b032b29 8b75fc          mov     esi,dword ptr [ebp-4] ss:0023:04acc0ec=0bd2bfc8
0:007> g
(6b1b423d)   MSHTML!CBodyElement::CreateElement   |  (6b1b4320)   MSHTML!CBodyElement::`vftable'
Exact matches:
    MSHTML!CBodyElement::CreateElement = <no type information>
Element Address: 0bd2ffc0
eax=00000000 ebx=0bb33f28 ecx=00000012 edx=6af96e25 esi=0bd14da8 edi=0bd14cf8
eip=6b032b29 esp=04acc1a8 ebp=04acc1c0 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
MSHTML!CHtml5TreeConstructor::InsertAnHTMLElement+0x48:
6b032b29 8b75fc          mov     esi,dword ptr [ebp-4] ss:0023:04acc1bc=0bd2ffc0
0:007> g
(6b1dcc3d)   MSHTML!CScriptElement::CreateElement   |  (6b1dccb0)   MSHTML!CScriptElement::`vftable'
Exact matches:
    MSHTML!CScriptElement::CreateElement = <no type information>
Element Address: 0bd35f40
eax=00000000 ebx=0bb33f50 ecx=00000065 edx=6af96e25 esi=0bd14d78 edi=0bd14cf8
eip=6b032b29 esp=04acc158 ebp=04acc170 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
MSHTML!CHtml5TreeConstructor::InsertAnHTMLElement+0x48:
6b032b29 8b75fc          mov     esi,dword ptr [ebp-4] ss:0023:04acc16c=0bd35f40

```

CXXXElement

![](README/InternetExplorer0.png)

CTreeNode和CTreePos

CTreePos在逻辑上代表着一个 Element 对应的 tag 的头标签和尾标签, DOM 流即是这些 CTreePos 对象链接而成的双向链表。

![](README/InternetExplorer1.png)


# VBScriptBasics
## VarType
|Constant|Value|Description|
| :------: | :------: | :------: |
|vbEmpty|0|Empty (uninitialized)|
|vbNull|1|Null (no valid data)|
|vbInteger|2|Integer|
|vbLong|3|Long integer|
|vbSingle|4|Single-precision floating-point number|
|vbDouble|5|Double-precision floating-point number|
|vbCurrency|6|Currency value|
|vbDate|7|Date value|
|vbString|8|String|
|vbObject|9|Object|
|vbError |10|Error value|
|vbBoolean|11|Boolean value|
|vbVariant|12|Variant (used only with arrays of variants)|
|vbDataObject|13|A data access object|
|vbDecimal|14|Decimal value|
|vbByte|17|Byte value|
|vbUserDefinedType|36|Variants that contain user-defined types|
|VT_FUNC|76（0x4c）|
|vbArray|0x2000|Array|
|VT_BYREF|0x4000|
|VT_RESERVED|0x8000|


## VBScriptClass
```
<script LANGUAGE="VBScript">
Dim X
Class TestClass
    Dim a,b
    
    Private Sub Class_Initialize   
        a=&h1122334
        b="test string"
    End Sub
    Private Sub Class_Terminate   
    End Sub
    
    Sub test_fun
        test_fun=1
    End Sub
    
End Class
Set X = New TestClass
IsEmpty(X)

</script>
```

![](README/VbscriptBasics0.png)

调试过程如下：

![](README/VbscriptBasics2.png)
![](README/VbscriptBasics3.png)
![](README/VbscriptBasics4.png)


# FlashBasics

![](README/InternetExplorer4.png)

![](README/InternetExplorer2.png)


# Further Reading
1. https://hk.saowen.com/a/cb8011f66d4d2d723d9a95094c5432db0e3e75f2481341690342f1028f9c9ea0
2. https://www.blackhat.com/docs/us-14/materials/us-14-Yu-Write-Once-Pwn-Anywhere.pdf
3. https://www.blackhat.com/docs/asia-14/materials/Yason/WP-Asia-14-Yason-Diving-Into-IE10s-Enhanced-Protected-Mode-Sandbox.pdf 
4. https://msdn.microsoft.com/en-us/library/cc237865.aspx
